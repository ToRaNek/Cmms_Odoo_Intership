<?xml version="1.0" encoding="utf-8"?>
<!-- custom_addons/cmms_3d_models/views/maintenance_request_views_parts_corrected.xml -->
<odoo>
    <!-- Vue principale pour les demandes de maintenance avec pièces -->
    <record id="view_maintenance_request_form_with_parts" model="ir.ui.view">
        <field name="name">maintenance.request.form.with.parts</field>
        <field name="model">maintenance.request</field>
        <field name="inherit_id" ref="maintenance.hr_equipment_request_view_form"/>
        <field name="arch" type="xml">
            <!-- Ajouter les champs obligatoires -->
            <xpath expr="//field[@name='equipment_id']" position="attributes">
                <attribute name="required">1</attribute>
            </xpath>

            <xpath expr="//field[@name='user_id']" position="attributes">
                <attribute name="required">1</attribute>
            </xpath>

            <xpath expr="//field[@name='schedule_date']" position="attributes">
                <attribute name="required">1</attribute>
            </xpath>

            <!-- Ajouter un bouton statistique pour les pièces -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_parts" type="object"
                        class="oe_stat_button" icon="fa-cogs"
                        attrs="{'invisible': [('part_count', '=', 0)]}">
                    <field name="part_count" string="Pièces" widget="statinfo"/>
                </button>
            </xpath>

            <!-- Ajouter la section des pièces à la fin du formulaire -->
            <xpath expr="//sheet" position="inside">
                <div class="oe_clear"/>
                
                <!-- Section Assignations (existante) -->
                <h2>Assignations</h2>
                <button name="set_all_as_primary" type="object"
                        string="Marquer tous comme assignés principaux"
                        class="btn btn-primary mb-2"
                        attrs="{'invisible': [('assignment_ids', '=', [])]}"/>

                <div style="width: 100%; margin-bottom: 16px;">
                    <field name="assignment_ids"
                           context="{'default_request_id': active_id}"
                           options="{'reload_on_button': true}"
                           mode="tree" style="width: 100%;">
                        <tree editable="bottom" create="1" delete="1" limit="15">
                            <field name="person_id" domain="[('active', '=', True)]" options="{'no_create': false}"/>
                            <field name="role_id" readonly="1"/>
                            <field name="user_id" readonly="1"/>
                            <field name="assigned_date"/>
                            <field name="assigned_by_id" readonly="1"/>
                            <field name="is_primary"/>
                            <field name="notes"/>
                        </tree>
                    </field>
                </div>

                <!-- Champs cachés pour la compatibilité -->
                <field name="assigned_person_ids" invisible="1"/>
                <field name="primary_assignment_id" invisible="1"/>
                <field name="primary_assignment_ids" invisible="1"/>
                <field name="assigned_person_id" invisible="1"/>
                <field name="assigned_user_id" invisible="1"/>
                <field name="assigned_person_role" invisible="1"/>

                <!-- NOUVELLE SECTION: Pièces spécifiques -->
                <div class="oe_clear"/>
                <h2>Pièces spécifiques à maintenir</h2>
                
                <!-- Alert informatif -->
                <div class="alert alert-info" role="alert"
                     attrs="{'invisible': ['|', ('equipment_id', '=', False), ('part_ids', '!=', [])]}">
                    <p><strong>Sélection de pièces spécifiques</strong></p>
                    <p>Vous pouvez sélectionner les pièces précises de l'équipement qui nécessitent une intervention.</p>
                    <p><small>Les pièces disponibles correspondent aux sous-modèles 3D de l'équipement sélectionné.</small></p>
                </div>

                <!-- Alert si pas d'équipement sélectionné -->
                <div class="alert alert-warning" role="alert"
                     attrs="{'invisible': [('equipment_id', '!=', False)]}">
                    <p><strong>Sélectionnez d'abord un équipement</strong></p>
                    <p>Pour pouvoir choisir des pièces spécifiques, vous devez d'abord sélectionner un équipement.</p>
                </div>

                <!-- Tableau des pièces avec autocomplétion et validation -->
                <field name="part_ids"
                       context="{'default_request_id': active_id, 'equipment_id': equipment_id}"
                       attrs="{'invisible': [('equipment_id', '=', False)]}"
                       options="{'reload_on_button': true}">
                    <tree editable="bottom" create="1" delete="1">
                        <!-- Champ pièce avec autocomplétion filtrée -->
                        <field name="submodel_id" 
                               string="Pièce"
                               domain="[('parent_id.equipment_ids', 'in', [parent.equipment_id])]"
                               options="{'no_create': True}"
                               placeholder="Rechercher une pièce (ex: br pour brushes)..."
                               required="1"/>
                        
                        <!-- Nom de la pièce (calculé, lecture seule) -->
                        <field name="part_name" readonly="1" optional="hide"/>
                        
                        <!-- Type d'intervention (obligatoire) -->
                        <field name="intervention_type" 
                               string="Type d'intervention"
                               required="1"/>
                        
                        <!-- Champ "Autre" visible seulement si intervention_type = 'other' -->
                        <field name="intervention_other" 
                               string="Préciser"
                               attrs="{'invisible': [('intervention_type', '!=', 'other')],
                                      'required': [('intervention_type', '=', 'other')]}"
                               placeholder="Préciser le type d'intervention..."/>
                        
                        <!-- Description du problème (optionnel) -->
                        <field name="description" 
                               string="Description du problème"
                               placeholder="Décrire le problème sur cette pièce (optionnel)..."/>
                        
                        <!-- Séquence pour l'ordre -->
                        <field name="sequence" optional="hide"/>
                        
                        <!-- Champs techniques cachés -->
                        <field name="equipment_id" invisible="1"/>
                        <field name="parent_model3d_id" invisible="1"/>
                        <field name="request_id" invisible="1"/>
                    </tree>
                </field>

                <!-- Message d'aide si l'équipement n'a pas de modèle 3D -->
                <div class="alert alert-secondary" role="alert"
                     attrs="{'invisible': ['|', ('equipment_id', '=', False), ('equipment_id.has_3d_model', '=', True)]}">
                    <p><strong>Équipement sans modèle 3D</strong></p>
                    <p>L'équipement sélectionné n'a pas de modèle 3D associé, donc aucune pièce spécifique n'est disponible.</p>
                    <p>Vous pouvez continuer sans sélectionner de pièces spécifiques.</p>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Étendre la vue liste des demandes de maintenance -->
    <record id="view_maintenance_request_tree_inherit_parts" model="ir.ui.view">
        <field name="name">maintenance.request.tree.inherit.parts</field>
        <field name="model">maintenance.request</field>
        <field name="inherit_id" ref="maintenance.hr_equipment_request_view_tree"/>
        <field name="arch" type="xml">
            <!-- Ajouter la colonne nombre de pièces -->
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="part_count" string="Pièces" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Étendre la vue recherche des demandes de maintenance -->
    <record id="view_maintenance_request_search_inherit_parts" model="ir.ui.view">
        <field name="name">maintenance.request.search.inherit.parts</field>
        <field name="model">maintenance.request</field>
        <field name="inherit_id" ref="maintenance.hr_equipment_request_view_search"/>
        <field name="arch" type="xml">
            <!-- Ajouter des champs de recherche -->
            <xpath expr="//field[@name='user_id']" position="after">
                <field name="part_ids" string="Pièces"/>
            </xpath>

            <!-- Ajouter des filtres -->
            <xpath expr="//filter[last()]" position="after">
                <separator/>
                <filter string="Avec pièces spécifiques" name="has_parts"
                        domain="[('part_count', '>', 0)]"/>
                <filter string="Sans pièces spécifiques" name="no_parts"
                        domain="[('part_count', '=', 0)]"/>
            </xpath>

            <!-- Ajouter groupement par nombre de pièces -->
            <xpath expr="//group" position="inside">
                <filter string="Nombre de pièces" name="group_by_part_count"
                        context="{'group_by': 'part_count'}"/>
            </xpath>
        </field>
    </record>
</odoo>